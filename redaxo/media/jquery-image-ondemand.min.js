jQuery(function($){
  'use strict';
  var imgLoadedH = false;
  var imgLoadedW = false;
  var offset = 50;
  function CheckLoad(elem) {
    var p = $(window).height() + $(window).scrollTop();
    var w = $(window).width() + $(window).scrollLeft();
    var img = $(elem);
    var blnInRange = (img.offset().top < p + offset && img.offset().left < w + offset);
    if (blnInRange) {
      img.attr('src', img.attr('longdesc')).removeClass('img-ondemand');
    }
  }
  function imgOndemand(visChange) {
    var docHeight = $(document).height();
    var docWidth = $(document).width();
    if (!imgLoadedH || !imgLoadedW || visChange) {
      $('img.img-ondemand').each(function () {
        CheckLoad(this);
      });
      $('input.img-ondemand').each(function () {
        CheckLoad(this);
      });
      imgLoadedH = ($(window).height() + $(window).scrollTop()) >= docHeight;
      imgLoadedW = ($(window).width() + $(window).scrollLeft()) >= docWidth;
    }
  }
  imgOndemand();
  $(window).scroll(function () {
    imgOndemand();
  });
  // fix inital loading in Safari
  setTimeout(function(){
    $(window).trigger('scroll');
  },200);
});